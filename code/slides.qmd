---
title: "Basketball Analytics with R"
author: "Mathew Chandy"
execute:
  echo: true
  format: revealjs
  embed-resources: true
---

# sportsdataverse

The SportsDataverse is a collection of R packages that can be used for a 
variety of sports. Below are the SportsDataverse packages that can be used for 
basketball analytics:

* [hoopR](https://hoopr.sportsdataverse.org)
* [wehoop](https://wehoop.sportsdataverse.org/)
* [sportyR](https://sportyr.sportsdataverse.org/)

## Installing the collection

```{r include = FALSE}
Sys.setenv("VROOM_CONNECTION_SIZE" = 500000)
```

```{r message = FALSE, warning = FALSE, output = FALSE}
if (!requireNamespace('devtools', quietly = TRUE)){
  install.packages('devtools')
}
devtools::install_github(repo = "sportsdataverse/sportsdataverse-R")
```

## hoopR

Can be used for men's basketball analysis for the NBA and the NCAA.

## BasketballAnalyzeR: Assist Network
```{r}
library(BasketballAnalyzeR)
PbP <- PbPmanipulation(PbP.BDB)
PbP.BOS <- subset(PbP, team == "BOS")
out <- assistnet(PbP.BOS)
plot(out, layout = "circle", edge.thr = 30, node.col = "FGM_ASTp", 
     node.size = "ASTPTS")
```

## hoopR: Clustering
```{r, include = FALSE}
library(hoopR)
library(tidyverse)
fg_pct_stats <- nba_leaguedashptteamdefend(league_id = '00', 
                           season = year_to_season(most_recent_nba_season() - 1))[[1]] %>% 
  select(TEAM_ABBREVIATION, D_FG_PCT, NORMAL_FG_PCT) %>% 
  as.data.frame()
rownames(fg_pct_stats) <- fg_pct_stats$TEAM_ABBREVIATION
fg_pct_stats <- fg_pct_stats %>% select(-TEAM_ABBREVIATION) %>% 
  mutate(D_FG_PCT = as.numeric(D_FG_PCT),
                               NORMAL_FG_PCT = as.numeric(NORMAL_FG_PCT))
```

```{r}
library(factoextra)
res.km <- kmeans(fg_pct_stats, centers = 3)
fviz_cluster(res.km, data = fg_pct_stats,
             palette = c("#2E9FDF", "#00AFBB", "#E7B800"), 
             geom = "text",
             ellipse.type = "convex", 
             ggtheme = theme_bw())
```

## wehoop
```{r, warning = FALSE}
library(wehoop)
```

## nbastatR and sportyR
```{r, include = FALSE}
devtools::install_github("abresler/nbastatR")
library(nbastatR)
library(sportyR)

width = 50
height = 94 / 2
key_height = 19
inner_key_width = 12
outer_key_width = 16
backboard_width = 6
backboard_offset = 4
neck_length = 0.5
hoop_radius = 0.75
hoop_center_y = backboard_offset + neck_length + hoop_radius
three_point_radius = 23.75
three_point_side_radius = 22
three_point_side_height = 14

gsw <- teams_shots(teams = "Golden State Warriors", seasons = 2023, 
                   season_types = "Playoffs")

curry <- gsw %>% filter(namePlayer == "Stephen Curry") %>% 
  mutate(x = as.numeric(as.character(locationX)) / 10, 
         y = as.numeric(as.character(locationY)) / 10 - height + hoop_center_y,
         z = ifelse(typeEvent == "Missed Shot", 1, 0),
         factor_x = as.character(floor(x) %% 10),
         factor_y = as.character(floor(y) %% 10))
```
```{r}
geom_basketball(league = "NBA", rotation = 270, display_range = "offense") +
  stat_binhex(data = curry, aes(x, y))
```

# March Madness
```{r}
library(hoopR)
library(data.tree)
library(treemap)
tournament23 <- load_mbb_schedule(seasons = 2023) %>% 
  filter(grepl("Men's Basketball Championship", notes_headline) & 
           !grepl("First Four", notes_headline)) %>% 
  select(notes_headline, home_abbreviation, home_conference_id, home_score, 
         home_winner, home_current_rank, home_linescores, home_records,
         away_abbreviation, away_conference_id, away_score, away_winner,
         away_current_rank, away_linescores, away_records
         ) %>% 
  mutate(final_four = case_when(grepl("Midwest", notes_headline) |
                                grepl("West", notes_headline) |
                                home_abbreviation == "CONN" & 
                                away_abbreviation == "MIA" ~ "midwest_west",
                                grepl("South", notes_headline) |
                                grepl("East", notes_headline) |
                                home_abbreviation == "SDSU" &
                                away_abbreviation == "FAU" ~ "south_east"),
         # The pairings are different for each year
         elite_eight = case_when(
                            grepl("Midwest", notes_headline) ~ "midwest",
                            grepl("South", notes_headline) ~ "south",
                            grepl("West", notes_headline) ~ "west",
                            grepl("East", notes_headline) ~ "east"),
         sweet_sixteen = ifelse(grepl("Sweet 16", notes_headline) |
                                grepl("2nd Round", notes_headline) |
                                grepl("1st Round", notes_headline),
                                case_when(
                                  home_current_rank %in% 
                                    c(1, 4, 5, 8, 9, 12) ~ 1,
                                  home_current_rank %in% 
                                    c(2, 3, 6, 7, 10, 11) ~ 2), NA),
         round_of_32 = ifelse(grepl("2nd Round", notes_headline) |
                              grepl("1st Round", notes_headline),
                              case_when(
                                 home_current_rank %in% c(1, 8, 9) ~ 1,
                                 home_current_rank %in% c(2, 7, 10) ~ 2,
                                 home_current_rank %in% c(3, 6, 11) ~ 3,
                                 home_current_rank %in% c(4, 5, 12) ~ 4), NA),
         round_of_64 = ifelse(grepl("1st Round", notes_headline),
                         home_current_rank,
                         NA)
         )


start23 <- tournament23 %>% 
  na.omit() %>% 
  mutate(home_records = str_extract_all(home_records, "\\d+"),
         away_records = str_extract_all(away_records, "\\d+"),
         home_overall_wins = 
           as.numeric(sapply(home_records, function(x) x[[1]])),
         home_overall_losses = 
           as.numeric(sapply(home_records, function(x) x[[2]])),
         away_overall_wins = 
           as.numeric(sapply(away_records, function(x) x[[1]])),
         away_overall_losses = 
           as.numeric(sapply(away_records, function(x) x[[2]])),
         home_p = as.numeric(home_overall_wins) / 
           (as.numeric(home_overall_wins) + as.numeric(home_overall_losses)),
         away_p = as.numeric(away_overall_wins) / 
           (as.numeric(away_overall_wins) + as.numeric(away_overall_losses)))
start23$pathString <- paste("national", 
                            start23$final_four, 
                            start23$elite_eight,
                            start23$sweet_sixteen,
                            start23$round_of_32,
                            start23$round_of_64,
                            sep = "/")
bracket <- as.Node(start23)
print(bracket, "home_abbreviation", "home_p", "away_abbreviation", "away_p")
```



```{r, error = TRUE}
log5 <- function(p, q) p * (1 - q) / (p + q - 2 * p * q)
exp_winner <- function(bracket, prob_func) {

  game = bracket$root
  # base case
  if (length(game$Get("home_abbreviation")) == 1) {
    # probability a team makes it to that game/round
    home_names <- str(game$Get("home_abbreviation"))
    home_round <- c(home_names = 1)
    away_names <- str(game$Get("away_abbreviation"))
    away_round <- c(away_names = 1)
    
    # probability a matchup happens
    matchups <- expand_grid(home_round, away_round) %>% 
      mutate(matchup = home_round * away_round,
             home_team = names(home_round),
             away_team = names(away_round),
             home_ingredients = game$home_p,
             away_ingredients = game$away_p,
             home_win = prob_func(home_ingredients, away_ingredients),
             away_win = 1 - home_win,
             home_advance = matchup * home_win,
             away_advance = mathcup * away_win
             )
    
    home <- matchups %>% 
      group_by(home_team) %>% 
      summarize(advance = sum(home_advance))
    
    away <- matchups %>% 
      group_by(away_team) %>% 
      summarize(advance = sum(away_advance))
    

    game$teams <- rbind(home, away)
    
  } else { 
    # recursive case
    # probability a team makes it to that game/round
   
    home_round <- exp_winner(game$children[1], prob_func)
    away_round <- exp_winner(game$children[2], prob_func)
    
    # probability a matchup happens
    matchups <- expand_grid(home_round, away_round) %>% 
      mutate(matchup = home_round * away_round,
             home_team = names(home_round),
             away_team = names(away_round),
             home_ingredients = rep(c(game$children[1]$home_p, 
                                  game$children[1]$away_p), each = 2),
             away_ingredients = rep(c(game$children[2]$home_p, 
                                  game$children[2]$away_p), times = 2),
             home_win = prob_func(home_ingredients, away_ingredients),
             away_win = 1 - home_win,
             home_advance = matchup * home_win,
             away_advance = mathcup * away_win
             )
    
    home <- matchups %>% 
      group_by(home_team) %>% 
      summarize(advance = sum(home_advance))
    
    away <- matchups %>% 
      group_by(away_team) %>% 
      summarize(advance = sum(away_advance))
    
    
    game$teams <- rbind(home, away)
  }
  
  return(game)
  
  
}

exp_winner(bracket, log5)
```






